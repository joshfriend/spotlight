name: "Publish"

on:
  workflow_run:
    workflows: ["Test and Check"]
    types: [completed]
    branches: [main]
    tags:
      - '*'

concurrency:
  group: "release"

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      is-snapshot: ${{ steps.check_version.outputs.is_snapshot }}
      version: ${{ steps.check_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - id: check_version
        run: |
          VERSION_VALUE=$(grep '^VERSION_NAME=' gradle.properties | cut -d'=' -f2 | xargs)
          echo "version=$VERSION_VALUE" >> "$GITHUB_OUTPUT"
          if [[ "$VERSION_VALUE" == *"-SNAPSHOT" ]]; then
            echo "is_snapshot=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_snapshot=false" >> "$GITHUB_OUTPUT"
          fi

  maven-central:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.repository == 'joshfriend/spotlight'
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Configure Gradle for optimal use in GitHub Actions, including caching of downloaded dependencies.
      # See: https://github.com/gradle/actions/blob/main/setup-gradle/README.md
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Publish to Maven Central
        run: ./gradlew publishAllPublicationsToMavenCentralRepository --no-configuration-cache -Dorg.gradle.unsafe.isolated-projects=false
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_SECRET_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_SECRET_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_SECRET_KEY_PASSWORD }}

  gradle-plugin-portal:
    needs: prepare-release
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.repository == 'joshfriend/spotlight' &&
        needs.prepare-release.outputs.is-snapshot == 'false'
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Configure Gradle for optimal use in GitHub Actions, including caching of downloaded dependencies.
      # See: https://github.com/gradle/actions/blob/main/setup-gradle/README.md
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Publish to Gradle Plugin Portal
        run: ./gradlew publishPlugins --no-configuration-cache -Dorg.gradle.unsafe.isolated-projects=false
        env:
          GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
          GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_SECRET_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_SECRET_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_SECRET_KEY_PASSWORD }}

  jetbrains:
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.repository == 'joshfriend/spotlight'
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Configure Gradle for optimal use in GitHub Actions, including caching of downloaded dependencies.
      # See: https://github.com/gradle/actions/blob/main/setup-gradle/README.md
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Publish to JetBrains Marketplace
        run: ./gradlew :spotlight-idea-plugin:publishPlugin -PbuildIdePlugin=true
        env:
          JETBRAINS_MARKETPLACE_TOKEN: ${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}

  create-github-release:
    needs: prepare-release
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.repository == 'joshfriend/spotlight' &&
        needs.prepare-release.outputs.is-snapshot == 'false'
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tag exists and extract changelog
        id: changelog
        run: |
          VERSION="${{ needs.prepare-release.outputs.version }}"
          TAG_NAME="v$VERSION"

          # Check if a tag exists for this version
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "No tag found for version $VERSION, skipping release creation"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

          # Extract the changelog section for this version
          # This awk script finds the version header and extracts content until the next version header
          # It handles subcategories (#### headers) within a version section
          # Use a temporary file to avoid shell interpretation of special characters
          awk -v version="$VERSION" '
            /^### / {
              if (found) exit
              if ($0 ~ "### " version) {
                found=1
                next
              }
            }
            found { print }
          ' CHANGELOG.md > /tmp/changelog.txt

          if [ ! -s /tmp/changelog.txt ]; then
            echo "No changelog entry found for version $VERSION"
            echo "Release $VERSION" > /tmp/changelog.txt
          fi

          # Output the changelog entry for the release notes
          {
            echo "notes<<EOF"
            cat /tmp/changelog.txt
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: steps.changelog.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if release already exists
          if gh release view "v${{ needs.prepare-release.outputs.version }}" >/dev/null 2>&1; then
            echo "Release already exists, skipping"
            exit 0
          fi

          gh release create "v${{ needs.prepare-release.outputs.version }}" \
            --title "v${{ needs.prepare-release.outputs.version }}" \
            --notes "${{ steps.changelog.outputs.notes }}"
